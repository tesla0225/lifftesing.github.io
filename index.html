<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE通知の登録</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #06c755 0%, #04a847 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: #06c755;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon svg {
      width: 40px;
      height: 40px;
      fill: white;
    }
    h1 {
      font-size: 22px;
      color: #333;
      margin-bottom: 12px;
    }
    .description {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 30px;
    }
    .status {
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .status.loading {
      background: #f5f5f5;
      color: #666;
    }
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    .status-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .status-text {
      font-size: 16px;
      font-weight: bold;
    }
    .status-detail {
      font-size: 13px;
      margin-top: 8px;
      opacity: 0.8;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #06c755;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .close-btn {
      background: #06c755;
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: none;
    }
    .close-btn:hover {
      background: #05b34c;
    }
    .close-btn.show {
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
    </div>
    <h1>LINE通知の登録</h1>
    <p class="description">リマインドなどの通知をLINEで受け取れるようになります</p>
    
    <div id="status" class="status loading">
      <div class="spinner"></div>
      <div class="status-text">登録処理中...</div>
      <div class="status-detail">しばらくお待ちください</div>
    </div>
    
    <button id="closeBtn" class="close-btn" onclick="closeWindow()">閉じる</button>
  </div>

  <script>
    // ============================================
    // 設定（デプロイ時に書き換え）
    // ============================================
    const CONFIG = {
      // LIFFアプリID（LINE Developersで作成後に設定）
      LIFF_ID: '<<PLACEHOLDER_LIFF_ID>>',
      
      // n8n Webhook URL（n8nでワークフロー作成後に設定）
      WEBHOOK_URL: '<<PLACEHOLDER_N8N_WEBHOOK_URL>>'
    };

    // ============================================
    // メイン処理
    // ============================================
    async function main() {
      try {
        // 1. LIFF初期化
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // 2. ログイン確認
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        
        // 3. URLからcandidate_idを取得
        const params = new URLSearchParams(window.location.search);
        const candidateId = params.get('cid') || params.get('candidate_id');
        
        if (!candidateId) {
          showStatus('error', 'エラー', '登録情報が見つかりません。URLをご確認ください。');
          return;
        }
        
        // 4. LINEプロフィール取得（userId含む）
        const profile = await liff.getProfile();
        
        // 5. n8n Webhookに送信
        const response = await fetch(CONFIG.WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            candidateId: candidateId,
            lineUserId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl || null,
            registeredAt: new Date().toISOString()
          })
        });
        
        if (!response.ok) {
          throw new Error('登録に失敗しました');
        }
        
        // 6. 成功表示
        showStatus('success', '登録完了！', 'LINEで通知を受け取れるようになりました');
        
      } catch (error) {
        console.error('Error:', error);
        showStatus('error', '登録できませんでした', error.message || 'しばらく経ってから再度お試しください');
      }
    }

    // ============================================
    // UI更新
    // ============================================
    function showStatus(type, title, detail) {
      const statusEl = document.getElementById('status');
      const closeBtn = document.getElementById('closeBtn');

      statusEl.className = `status ${type}`;

      let icon = '';
      if (type === 'success') icon = '✅';
      if (type === 'error') icon = '❌';

      // XSS対策: innerHTMLではなくtextContentを使用
      statusEl.innerHTML = '';

      const iconDiv = document.createElement('div');
      iconDiv.className = 'status-icon';
      iconDiv.textContent = icon;

      const titleDiv = document.createElement('div');
      titleDiv.className = 'status-text';
      titleDiv.textContent = title;

      const detailDiv = document.createElement('div');
      detailDiv.className = 'status-detail';
      detailDiv.textContent = detail;

      statusEl.appendChild(iconDiv);
      statusEl.appendChild(titleDiv);
      statusEl.appendChild(detailDiv);

      closeBtn.classList.add('show');
    }

    function closeWindow() {
      if (liff.isInClient()) {
        liff.closeWindow();
      } else {
        window.close();
      }
    }

    // 実行
    main();
  </script>
</body>
</html>
